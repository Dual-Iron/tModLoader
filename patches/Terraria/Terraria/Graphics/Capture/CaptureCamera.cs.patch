--- src/decompiled/Terraria/Graphics/Capture/CaptureCamera.cs
+++ src/Terraria/Terraria/Graphics/Capture/CaptureCamera.cs
@@ -5,10 +_,15 @@
 using System.Drawing;
 using System.Drawing.Imaging;
 using System.IO;
+#if WINDOWS
 using System.Runtime.InteropServices;
+#endif
 using System.Threading;
 using Terraria.Graphics.Effects;
 using Terraria.Localization;
+#if !XNA
+using Terraria.Utilities;
+#endif
 
 namespace Terraria.Graphics.Capture
 {
@@ -158,7 +_,7 @@
 				}
 				else {
 					_graphics.SetRenderTarget(null);
-					SaveImage(_frameBuffer, captureChunk.ScaledArea.Width, captureChunk.ScaledArea.Height, ImageFormat.Png, _activeSettings.OutputName, captureChunk.Area.X + "-" + captureChunk.Area.Y + ".png");
+					SaveImage(_frameBuffer, captureChunk.ScaledArea.Width, captureChunk.ScaledArea.Height, _activeSettings.OutputName, captureChunk.Area.X + "-" + captureChunk.Area.Y + ".png");
 				}
 
 				_tilesProcessed += captureChunk.Area.Width * captureChunk.Area.Height;
@@ -177,10 +_,17 @@
 					byte* ptr4 = ptr3 + (destinationBufferWidth * area.Y + area.X << 2);
 					for (int i = 0; i < area.Height; i++) {
 						for (int j = 0; j < area.Width; j++) {
+#if XNA
-							ptr4[2] = *ptr2;
+							ptr4[2] = ptr2[0];
 							ptr4[1] = ptr2[1];
-							*ptr4 = ptr2[2];
+							ptr4[0] = ptr2[2];
 							ptr4[3] = ptr2[3];
+#else
+							ptr4[0] = ptr2[0];
+							ptr4[1] = ptr2[1];
+							ptr4[2] = ptr2[2];
+							ptr4[3] = ptr2[3];
+#endif
 							ptr2 += 4;
 							ptr4 += 4;
 						}
@@ -194,20 +_,24 @@
 
 		public float GetProgress() => _tilesProcessed / _totalTiles;
 
-		private bool SaveImage(int width, int height, ImageFormat imageFormat, string filename) {
+		private bool SaveImage(int width, int height, string filename) {
 			if (!Utils.TryCreatingDirectory(Main.SavePath + Path.DirectorySeparatorChar + "Captures" + Path.DirectorySeparatorChar))
 				return false;
 
 			try {
+#if XNA
 				using (Bitmap bitmap = new Bitmap(width, height)) {
 					System.Drawing.Rectangle rect = new System.Drawing.Rectangle(0, 0, width, height);
 					BitmapData bitmapData = bitmap.LockBits(rect, ImageLockMode.WriteOnly, PixelFormat.Format32bppPArgb);
 					IntPtr scan = bitmapData.Scan0;
 					Marshal.Copy(_outputData, 0, scan, width * height * 4);
 					bitmap.UnlockBits(bitmapData);
-					bitmap.Save(filename, imageFormat);
+					bitmap.Save(filename, ImageFormat.Png);
 					bitmap.Dispose();
 				}
+#else
+				SavePng(width, height, filename);
+#endif
 
 				return true;
 			}
@@ -217,25 +_,44 @@
 			}
 		}
 
+#if !XNA
+		private void SavePng(int width, int height, string filename) {
+			using (FileStream fileStream = File.Create(filename)) {
+				PlatformUtilities.SavePng(fileStream, width, height, width, height, _outputData);
+			}
+		}
+#endif
+
-		private void SaveImage(Texture2D texture, int width, int height, ImageFormat imageFormat, string foldername, string filename) {
+		private void SaveImage(Texture2D texture, int width, int height, string foldername, string filename) {
 			string text = Main.SavePath + Path.DirectorySeparatorChar + "Captures" + Path.DirectorySeparatorChar + foldername;
 			string filename2 = Path.Combine(text, filename);
 			if (!Utils.TryCreatingDirectory(text))
 				return;
 
+#if XNA
 			using (Bitmap bitmap = new Bitmap(width, height)) {
 				System.Drawing.Rectangle rect = new System.Drawing.Rectangle(0, 0, width, height);
+#else
+			{//keep the formatter happy
+#endif
 				int elementCount = texture.Width * texture.Height * 4;
 				texture.GetData(_outputData, 0, elementCount);
 				int num = 0;
 				int num2 = 0;
 				for (int i = 0; i < height; i++) {
 					for (int j = 0; j < width; j++) {
+#if XNA
 						byte b = _outputData[num + 2];
 						_outputData[num2 + 2] = _outputData[num];
 						_outputData[num2] = b;
 						_outputData[num2 + 1] = _outputData[num + 1];
 						_outputData[num2 + 3] = _outputData[num + 3];
+#else
+						_outputData[num2] = _outputData[num];
+						_outputData[num2 + 1] = _outputData[num + 1];
+						_outputData[num2 + 2] = _outputData[num + 2];
+						_outputData[num2 + 3] = _outputData[num + 3];
+#endif
 						num += 4;
 						num2 += 4;
 					}
@@ -243,18 +_,24 @@
 					num += texture.Width - width << 2;
 				}
 
+#if XNA
 				BitmapData bitmapData = bitmap.LockBits(rect, ImageLockMode.WriteOnly, PixelFormat.Format32bppPArgb);
 				IntPtr scan = bitmapData.Scan0;
 				Marshal.Copy(_outputData, 0, scan, width * height * 4);
 				bitmap.UnlockBits(bitmapData);
-				bitmap.Save(filename2, imageFormat);
+				bitmap.Save(filename2, ImageFormat.Png);
 			}
+#else
+			}
+
+			SavePng(width, height, filename);
+#endif
 		}
 
 		private void FinishCapture() {
 			if (_activeSettings.UseScaling) {
 				int num = 0;
-				while (!SaveImage(_outputImageSize.Width, _outputImageSize.Height, ImageFormat.Png, Main.SavePath + Path.DirectorySeparatorChar + "Captures" + Path.DirectorySeparatorChar + _activeSettings.OutputName + ".png")) {
+				while (!SaveImage(_outputImageSize.Width, _outputImageSize.Height, Main.SavePath + Path.DirectorySeparatorChar + "Captures" + Path.DirectorySeparatorChar + _activeSettings.OutputName + ".png")) {
 					GC.Collect();
 					Thread.Sleep(5);
 					num++;
@@ -279,6 +_,7 @@
 		}
 
 		public void Dispose() {
+#if CLIENT
 			Monitor.Enter(_captureLock);
 			if (!_isDisposed) {
 				_frameBuffer.Dispose();
@@ -293,6 +_,7 @@
 				_isDisposed = true;
 				Monitor.Exit(_captureLock);
 			}
+#endif
 		}
 	}
 }
